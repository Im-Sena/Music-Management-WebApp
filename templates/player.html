{% extends "base.html" %}

{% block title %}Now Playing - Music Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/player.css') }}">
{% endblock %}

{% block content %}
<div class="player-page">
    <a href="/" class="back-link">&larr; Back to Library</a>
    
    <div class="player-container">
        <!-- „Éó„É¨„Ç§„É§„Éº„ÅÆ„É°„Ç§„É≥ÈÉ®ÂàÜ -->
        <div class="now-playing">
            <!-- „Ç¢„É´„Éê„É†„Ç¢„Éº„Éà -->
            <div class="album-art-container">
                {% if song[7] %}
                <img src="/image/{{ song[0] }}" alt="Album art" class="album-art">
                {% else %}
                <div class="album-art no-image">
                    <span>üéµ</span>
                </div>
                {% endif %}
            </div>

            <!-- Êõ≤ÊÉÖÂ†± -->
            <div class="song-info">
                <h1 class="song-title">{{ song[1] }}</h1>
                <p class="song-artist">{{ song[2] }}</p>
                {% if song[3] != "Unknown" %}
                <p class="song-album">
                    <small>
                        {{ song[3] }}
                        {% if song[4] %}<span class="year">({{ song[4] }})</span>{% endif %}
                    </small>
                </p>
                {% endif %}
                {% if song[5] %}
                <p class="song-genre"><small>Genre: {{ song[5] }}</small></p>
                {% endif %}
            </div>

            <!-- „Ç™„Éº„Éá„Ç£„Ç™„Éó„É¨„Ç§„É§„Éº -->
            <div class="player-controls">
                <audio id="audioPlayer" controls style="width: 100%;">
                    <source src="/download/{{ song[0] }}?stream=true" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </div>

            <!-- ÂÜçÁîüÊÉÖÂ†± -->
            <div class="player-info">
                <div class="progress-info">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>

            <!-- „Éó„É¨„Ç§„É™„Çπ„Éà„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            {% if prev_song %}
            <div class="playlist-nav">
                <a href="/player/{{ prev_song[0] }}" class="btn btn-sm">‚èÆ Previous</a>
                <span class="song-counter">{{ current_index + 1 }} / {{ total_songs }}</span>
                {% if next_song %}
                <a href="/player/{{ next_song[0] }}" class="btn btn-sm">Next ‚è≠</a>
                {% endif %}
            </div>
            {% endif %}

            <!-- „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥ -->
            <div class="download-section">
                <a href="/download/{{ song[0] }}" class="btn btn-secondary">‚¨á Download</a>
            </div>
        </div>

        <!-- Ê¨°„ÅÆÊõ≤„Éó„É¨„Éì„É•„Éº -->
        {% if next_song %}
        <div class="next-song-preview">
            <h3>Next Song</h3>
            <div class="preview-card">
                {% if next_song[7] %}
                <img src="/image/{{ next_song[0] }}" alt="Next album art" class="preview-thumbnail">
                {% endif %}
                <div>
                    <p class="preview-title">{{ next_song[1] }}</p>
                    <p class="preview-artist">{{ next_song[2] }}</p>
                    <a href="/player/{{ next_song[0] }}" class="btn btn-sm btn-primary">Play Now</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript „ÅßÂÜçÁîüÊôÇÈñì„ÇíË°®Á§∫ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const audio = document.getElementById('audioPlayer');
    const currentTimeSpan = document.getElementById('currentTime');
    const durationSpan = document.getElementById('duration');

    // Êõ≤„ÅÆÈï∑„Åï„ÅåË™≠„ÅøËæº„Åæ„Çå„ÅüÊôÇ
    audio.addEventListener('loadedmetadata', function() {
        durationSpan.textContent = formatTime(audio.duration);
    });

    // ÂÜçÁîüÊôÇÈñì„ÅåÊõ¥Êñ∞„Åï„Çå„Åü„Å®„Åç
    audio.addEventListener('timeupdate', function() {
        currentTimeSpan.textContent = formatTime(audio.currentTime);
    });

    // Ê¨°„ÅÆÊõ≤„Å∏Ëá™ÂãïÈÅ∑Áßª
    audio.addEventListener('ended', function() {
        const nextButton = document.querySelector('a[href*="/player/"]');
        const links = document.querySelectorAll('a[href*="/player/"]');
        if (links.length > 1) {
            // Ê¨°„ÅÆÊõ≤„Å∏ÁßªÂãï„Åô„Çã„Éú„Çø„É≥„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØËá™ÂãïÈÅ∑Áßª
            window.location.href = links[links.length - 1].href;
        }
    });

    function formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
});
</script>
{% endblock %}
