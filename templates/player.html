{% extends "base.html" %}

{% block title %}再生中 - ULTRA ARCHIVES{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/player.css') }}">
{% endblock %}

{% block content %}
<div class="player-page">
    <a href="/" class="back-link">&larr; ライブラリに戻る</a>
    
    <div class="player-container">
        <!-- プレイヤーのメイン部分 -->
        <div class="now-playing">
            <!-- アルバムアート -->
            <div class="album-art-container">
                {% if song[7] %}
                <img src="/image/{{ song[0] }}" alt="Album art" class="album-art">
                {% else %}
                <div class="album-art no-image">
                    <span>♪</span>
                </div>
                {% endif %}
            </div>

            <!-- 曲情報 -->
            <div class="song-info">
                <h1 class="song-title">{{ song[1] }}</h1>
                <p class="song-artist">{{ song[2] }}</p>
                {% if song[3] != "Unknown" %}
                <p class="song-album">
                    <small>
                        {{ song[3] }}
                        {% if song[4] %}<span class="year">({{ song[4] }})</span>{% endif %}
                    </small>
                </p>
                {% endif %}
                {% if song[5] %}
                <p class="song-genre"><small>ジャンル: {{ song[5] }}</small></p>
                {% endif %}
            </div>

            <!-- オーディオプレイヤー -->
            <div class="player-controls">
                <audio id="audioPlayer" controls style="width: 100%;">
                    <source src="/download/{{ song[0] }}?stream=true" type="audio/mpeg">
                    ブラウザがオーディオ要素をサポートしていません。
                </audio>
            </div>

            <!-- 再生情報 -->
            <div class="player-info">
                <div class="progress-info">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>

            <!-- プレイリストナビゲーション -->
            {% if prev_song %}
            <div class="playlist-nav">
                <a href="/player/{{ prev_song[0] }}" class="btn btn-sm">前へ</a>
                <span class="song-counter">{{ current_index + 1 }} / {{ total_songs }}</span>
                {% if next_song %}
                <a href="/player/{{ next_song[0] }}" class="btn btn-sm">次へ</a>
                {% endif %}
            </div>
            {% endif %}

            <!-- ダウンロードボタン -->
            <div class="download-section">
                <a href="/download/{{ song[0] }}" class="btn btn-sm btn-secondary">ダウンロード</a>
            </div>
        </div>

        <!-- 次の曲プレビュー -->
        {% if next_song %}
        <div class="next-song-preview">
            <h3>次の曲</h3>
            <div class="preview-card">
                {% if next_song[7] %}
                <img src="/image/{{ next_song[0] }}" alt="Next album art" class="preview-thumbnail">
                {% endif %}
                <div>
                    <p class="preview-title">{{ next_song[1] }}</p>
                    <p class="preview-artist">{{ next_song[2] }}</p>
                    <a href="/player/{{ next_song[0] }}" class="btn btn-sm btn-primary">再生</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript で再生時間を表示 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const audio = document.getElementById('audioPlayer');
    const currentTimeSpan = document.getElementById('currentTime');
    const durationSpan = document.getElementById('duration');

    // 曲の長さが読み込まれた時
    audio.addEventListener('loadedmetadata', function() {
        durationSpan.textContent = formatTime(audio.duration);
    });

    // 再生時間が更新されたとき
    audio.addEventListener('timeupdate', function() {
        currentTimeSpan.textContent = formatTime(audio.currentTime);
    });

    // 次の曲へ自動遷移
    audio.addEventListener('ended', function() {
        const nextButton = document.querySelector('a[href*="/player/"]');
        const links = document.querySelectorAll('a[href*="/player/"]');
        if (links.length > 1) {
            // 次の曲へ移動するボタンが存在する場合は自動遷移
            window.location.href = links[links.length - 1].href;
        }
    });

    function formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
});
</script>
{% endblock %}
